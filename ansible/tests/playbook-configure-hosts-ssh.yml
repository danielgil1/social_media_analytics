---
- hosts: all
  become: true
  become_user: ubuntu
  remote_user: ubuntu
  gather_facts: false
  tasks:

    - name: Wait for ssh to be up
      become: false
      wait_for:
        port: {{SSH_PORT}}
        delay: 5
        connect_timeout: 5
        timeout: 360
        host: "{{ ansible_host }}"
      delegate_to: localhost

    - name: Creates destination directory for ssh key
      file:
        state: directory
        mode: 0700
        dest: /home/{{ ANSIBLE_USER }}/.ssh/

    - name: Push ssh key
      copy:
        src: "{{ ANSIBLE_SSH_PRIVATE_KEY_FILE }}"
        dest: /home/{{ ANSIBLE_USER }}/.ssh/authorized_keys
        owner: "{{ ANSIBLE_USER }}"
        mode: 0600
      register: rsa
      ignore_errors: true

    - name: Final
      pause:
        seconds: 1
        echo: false
        prompt: "Setup done!"